import{c as ne,b as re,r as N,j as e,B as I,C as U}from"./index-B3Ma6YUV.js";import{M as oe}from"./Modal-BNTK6mZB.js";import{c as O}from"./createLucideIcon-Cxa5orDZ.js";import{C as ie,a as le}from"./chevron-right-BhJLCnFn.js";import{c as ce,t as Y,m as Z,a as _,f as w}from"./format-DWPfdaBu.js";import{S as de}from"./share-2-C778O3UX.js";const me=[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]],xe=O("download",me);const ue=[["path",{d:"M13 21h8",key:"1jsn5i"}],["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],he=O("pen-line",ue);function F(n,s){const a=()=>ce(s?.in,NaN),c=fe(n);let i;if(c.date){const x=Ne(c.date,2);i=je(x.restDateString,x.year)}if(!i||isNaN(+i))return a();const j=+i;let y=0,C;if(c.time&&(y=be(c.time),isNaN(y)))return a();if(c.timezone){if(C=ve(c.timezone),isNaN(C))return a()}else{const x=new Date(j+y),T=Y(0,s?.in);return T.setFullYear(x.getUTCFullYear(),x.getUTCMonth(),x.getUTCDate()),T.setHours(x.getUTCHours(),x.getUTCMinutes(),x.getUTCSeconds(),x.getUTCMilliseconds()),T}return Y(j+y+C,s?.in)}const L={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},pe=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,ye=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,ge=/^([+-])(\d{2})(?::?(\d{2}))?$/;function fe(n){const s={},a=n.split(L.dateTimeDelimiter);let r;if(a.length>2)return s;if(/:/.test(a[0])?r=a[0]:(s.date=a[0],r=a[1],L.timeZoneDelimiter.test(s.date)&&(s.date=n.split(L.timeZoneDelimiter)[0],r=n.substr(s.date.length,n.length))),r){const c=L.timezone.exec(r);c?(s.time=r.replace(c[1],""),s.timezone=c[1]):s.time=r}return s}function Ne(n,s){const a=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+s)+"})|(\\d{2}|[+-]\\d{"+(2+s)+"})$)"),r=n.match(a);if(!r)return{year:NaN,restDateString:""};const c=r[1]?parseInt(r[1]):null,i=r[2]?parseInt(r[2]):null;return{year:i===null?c:i*100,restDateString:n.slice((r[1]||r[2]).length)}}function je(n,s){if(s===null)return new Date(NaN);const a=n.match(pe);if(!a)return new Date(NaN);const r=!!a[4],c=S(a[1]),i=S(a[2])-1,j=S(a[3]),y=S(a[4]),C=S(a[5])-1;if(r)return ke(s,y,C)?we(s,y,C):new Date(NaN);{const x=new Date(0);return!Me(s,i,j)||!De(s,c)?new Date(NaN):(x.setUTCFullYear(s,i,Math.max(c,j)),x)}}function S(n){return n?parseInt(n):1}function be(n){const s=n.match(ye);if(!s)return NaN;const a=E(s[1]),r=E(s[2]),c=E(s[3]);return Ie(a,r,c)?a*Z+r*_+c*1e3:NaN}function E(n){return n&&parseFloat(n.replace(",","."))||0}function ve(n){if(n==="Z")return 0;const s=n.match(ge);if(!s)return 0;const a=s[1]==="+"?-1:1,r=parseInt(s[2]),c=s[3]&&parseInt(s[3])||0;return Fe(r,c)?a*(r*Z+c*_):NaN}function we(n,s,a){const r=new Date(0);r.setUTCFullYear(n,0,4);const c=r.getUTCDay()||7,i=(s-1)*7+a+1-c;return r.setUTCDate(r.getUTCDate()+i),r}const Ce=[31,null,31,30,31,30,31,31,30,31,30,31];function V(n){return n%400===0||n%4===0&&n%100!==0}function Me(n,s,a){return s>=0&&s<=11&&a>=1&&a<=(Ce[s]||(V(n)?29:28))}function De(n,s){return s>=1&&s<=(V(n)?366:365)}function ke(n,s,a){return s>=1&&s<=53&&a>=0&&a<=6}function Ie(n,s,a){return n===24?s===0&&a===0:a>=0&&a<60&&s>=0&&s<60&&n>=0&&n<25}function Fe(n,s){return s>=0&&s<=59}const Ae=()=>{const n=ne(),{customers:s,diaryEntries:a,payments:r,updateDiaryEntry:c}=re(),[i,j]=N.useState(w(new Date,"yyyy-MM")),[y,C]=N.useState(""),[x,T]=N.useState("amount"),[b,$]=N.useState(null),[A,R]=N.useState(null),[z,P]=N.useState(""),g=N.useMemo(()=>{const t=a.filter(o=>o.date.startsWith(i)),l=r.filter(o=>o.date.startsWith(i)),d=t.reduce((o,h)=>o+h.quantity,0),m=t.reduce((o,h)=>o+h.amount,0),f=t.length,p=new Map;t.forEach(o=>{const h=p.get(o.customerId);if(h)h.totalQuantity+=o.quantity,h.totalAmount+=o.amount,h.deliveryCount+=1;else{const D=s.find(v=>v.id===o.customerId);p.set(o.customerId,{customerId:o.customerId,customerName:D?.name||"Unknown",totalQuantity:o.quantity,totalAmount:o.amount,deliveryCount:1})}}),l.forEach(o=>{if(!p.get(o.customerId)){const D=s.find(v=>v.id===o.customerId);p.set(o.customerId,{customerId:o.customerId,customerName:D?.name||"Unknown",totalQuantity:0,totalAmount:0,deliveryCount:0})}});const u=Array.from(p.values()).sort((o,h)=>h.totalAmount-o.totalAmount);return{month:i,totalQuantity:d,totalRevenue:m,deliveryCount:f,customerBreakdown:u}},[a,r,s,i]),B=y.trim().toLowerCase(),Q=N.useMemo(()=>{let t=g.customerBreakdown;B&&(t=t.filter(d=>{const m=s.find(p=>p.id===d.customerId);return[d.customerName,m?.phone||"",m?.address||""].join(" ").toLowerCase().includes(B)}));const l=t.map(d=>{const f=r.filter(u=>u.customerId===d.customerId&&u.date.startsWith(i)).reduce((u,o)=>u+o.amount,0),p=d.totalAmount-f;return{row:d,balance:p}});return l.sort((d,m)=>{switch(x){case"name":return d.row.customerName.localeCompare(m.row.customerName);case"balance":return m.balance-d.balance;case"amount":default:return m.row.totalAmount-d.row.totalAmount}}),l.map(d=>d.row)},[g.customerBreakdown,s,r,i,B,x]),M=N.useMemo(()=>b&&s.find(t=>t.id===b)||null,[b,s]),k=N.useMemo(()=>b?a.filter(t=>t.customerId===b&&t.date.startsWith(i)).sort((t,l)=>t.date.localeCompare(l.date)):[],[b,a,i]),W=N.useMemo(()=>b?r.filter(t=>t.customerId===b&&t.date.startsWith(i)).sort((t,l)=>t.date.localeCompare(l.date)):[],[b,r,i]),H=()=>{const t=F(i+"-01"),l=new Date(t.getFullYear(),t.getMonth()-1,1);j(w(l,"yyyy-MM"))},J=()=>{const t=F(i+"-01"),l=new Date(t.getFullYear(),t.getMonth()+1,1);j(w(l,"yyyy-MM"))},G=()=>{j(w(new Date,"yyyy-MM"))},K=()=>{const t=["Customer","Deliveries","Quantity (L)","Billed (₹)","Paid (₹)","Balance (₹)"],l=g.customerBreakdown.map(u=>{const h=r.filter(v=>v.customerId===u.customerId&&v.date.startsWith(i)).reduce((v,ae)=>v+ae.amount,0),D=u.totalAmount-h;return[u.customerName,u.deliveryCount,u.totalQuantity.toFixed(2),u.totalAmount.toFixed(2),h.toFixed(2),D.toFixed(2)]}),d=[[`Monthly Report - ${w(F(i+"-01"),"MMMM yyyy")}`],[],t,...l,[],["Total",g.deliveryCount,g.totalQuantity.toFixed(2),g.totalRevenue.toFixed(2),"",""]].map(u=>u.join(",")).join(`
`),m=new Blob([d],{type:"text/csv"}),f=URL.createObjectURL(m),p=document.createElement("a");p.href=f,p.download=`milkman-report-${i}.csv`,p.click(),URL.revokeObjectURL(f)},X=()=>{window.print()},ee=t=>{$(t)},q=()=>{$(null),R(null),P("")},te=t=>{const l=k.find(m=>m.id===t);if(!l||l.quantity<=0)return;const d=l.amount/l.quantity;R(t),P(d.toFixed(2))},se=t=>{if(t.preventDefault(),!A)return;const l=k.find(f=>f.id===A);if(!l||l.quantity<=0)return;const d=parseFloat(z);if(!d||d<=0){alert("Enter a valid price per litre");return}const m=parseFloat((l.quantity*d).toFixed(2));c(l.id,{amount:m}),R(null),P("")};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Monthly Reports"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"View detailed monthly summaries and analytics"})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(I,{variant:"secondary",onClick:X,children:"Print"}),e.jsxs(I,{onClick:K,children:[e.jsx(xe,{size:20,className:"mr-2"}),"Export CSV"]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{onClick:H,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(ie,{size:24})}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("input",{type:"month",value:i,onChange:t=>j(t.target.value),className:"px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"}),e.jsx(I,{variant:"secondary",size:"sm",onClick:G,children:"Current Month"})]}),e.jsx("button",{onClick:J,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(le,{size:24})})]}),e.jsx("div",{className:"text-center mt-4",children:e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:w(F(i+"-01"),"MMMM yyyy")})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(U,{className:"bg-gradient-to-br from-green-50 to-green-100 border border-green-200",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-green-600 font-medium",children:"Total Revenue"}),e.jsxs("p",{className:"text-4xl font-bold text-green-900 mt-2",children:["₹",g.totalRevenue.toFixed(2)]})]})}),e.jsx(U,{className:"bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-blue-600 font-medium",children:"Total Quantity"}),e.jsxs("p",{className:"text-4xl font-bold text-blue-900 mt-2",children:[g.totalQuantity.toFixed(1)," L"]})]})}),e.jsx(U,{className:"bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-purple-600 font-medium",children:"Total Deliveries"}),e.jsx("p",{className:"text-4xl font-bold text-purple-900 mt-2",children:g.deliveryCount})]})})]}),e.jsxs(U,{title:"Customer Breakdown",children:[e.jsxs("div",{className:"mb-3 flex flex-col gap-3 md:flex-row md:items-end md:justify-between",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsx("p",{className:"text-xs sm:text-sm text-gray-600",children:"Filter by customer name, phone, city or village (from address)."}),e.jsx("input",{type:"text",value:y,onChange:t=>C(t.target.value),placeholder:"Search by name / phone / address",className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Sort by"}),e.jsxs("select",{value:x,onChange:t=>T(t.target.value),className:"px-2 py-1.5 border border-gray-300 rounded-lg text-xs sm:text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white dark:bg-slate-800 dark:border-slate-700",children:[e.jsx("option",{value:"amount",children:"Billed (high to low)"}),e.jsx("option",{value:"balance",children:"Balance (high to low)"}),e.jsx("option",{value:"name",children:"Name (A–Z)"})]})]})]}),Q.length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-200",children:[e.jsx("th",{className:"text-left py-3 px-4 font-semibold text-gray-700",children:"Customer"}),e.jsx("th",{className:"text-right py-3 px-4 font-semibold text-gray-700",children:"Deliveries"}),e.jsx("th",{className:"text-right py-3 px-4 font-semibold text-gray-700",children:"Quantity (L)"}),e.jsx("th",{className:"text-right py-3 px-4 font-semibold text-gray-700",children:"Billed (₹)"}),e.jsx("th",{className:"text-right py-3 px-4 font-semibold text-gray-700",children:"Paid (₹)"}),e.jsx("th",{className:"text-right py-3 px-4 font-semibold text-gray-700",children:"Balance (₹)"}),e.jsx("th",{className:"text-center py-3 px-4 font-semibold text-gray-700",children:"Share"})]})}),e.jsx("tbody",{children:Q.map(t=>{const l=s.find(o=>o.id===t.customerId),m=r.filter(o=>o.customerId===t.customerId&&o.date.startsWith(i)).reduce((o,h)=>o+h.amount,0),f=t.totalAmount-m,p=()=>{if(!l?.phone){alert("This customer does not have a phone number saved.");return}const o=l.phone.replace(/\D/g,""),D=[`Milk Report for ${l.name} (${w(F(i+"-01"),"MMMM yyyy")})`,`Total Milk: ${t.totalQuantity.toFixed(2)} L`,`Total Billed: ₹${t.totalAmount.toFixed(2)}`,`Total Paid: ₹${m.toFixed(2)}`,`Balance: ₹${f.toFixed(2)}`].join(`
`),v=`https://wa.me/${o}?text=${encodeURIComponent(D)}`;window.open(v,"_blank")},u=()=>{ee(t.customerId)};return e.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50 cursor-pointer",onClick:u,children:[e.jsx("td",{className:"py-3 px-4 font-medium text-gray-900",children:t.customerName}),e.jsx("td",{className:"py-3 px-4 text-right text-gray-700",children:t.deliveryCount}),e.jsx("td",{className:"py-3 px-4 text-right text-gray-700",children:t.totalQuantity.toFixed(2)}),e.jsxs("td",{className:"py-3 px-4 text-right font-semibold text-gray-900",children:["₹",t.totalAmount.toFixed(2)]}),e.jsxs("td",{className:"py-3 px-4 text-right text-gray-700",children:["₹",m.toFixed(2)]}),e.jsxs("td",{className:"py-3 px-4 text-right text-gray-700",children:["₹",f.toFixed(2)]}),e.jsx("td",{className:"py-3 px-4 text-center",children:e.jsxs("button",{onClick:o=>{o.stopPropagation(),p()},className:"inline-flex items-center px-3 py-1 text-xs rounded-lg bg-blue-50 hover:bg-blue-100 text-blue-700",disabled:!l?.phone,children:[e.jsx(de,{size:14,className:"mr-1"}),"WhatsApp"]})})]},t.customerId)})}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"bg-gray-50 font-bold",children:[e.jsx("td",{className:"py-3 px-4",children:"Total"}),e.jsx("td",{className:"py-3 px-4 text-right",children:g.deliveryCount}),e.jsx("td",{className:"py-3 px-4 text-right",children:g.totalQuantity.toFixed(2)}),e.jsxs("td",{className:"py-3 px-4 text-right",children:["₹",g.totalRevenue.toFixed(2)]}),e.jsx("td",{className:"py-3 px-4 text-right",children:"-"}),e.jsx("td",{className:"py-3 px-4 text-right",children:"-"}),e.jsx("td",{className:"py-3 px-4"})]})})]})}):e.jsx("p",{className:"text-gray-500 text-center py-8",children:y?"No customers match this search for the selected month":"No data for this month"})]}),e.jsx(oe,{isOpen:!!b,onClose:q,title:M?`${M.name} - ${w(F(i+"-01"),"MMMM yyyy")}`:"Customer Details",children:M?e.jsxs("div",{className:"space-y-6 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"text-xs text-gray-500",children:[e.jsxs("p",{children:["Customer ID: ",M.id]}),M.phone&&e.jsxs("p",{children:["Phone: ",M.phone]})]}),e.jsx(I,{size:"sm",variant:"secondary",onClick:()=>{n(`/customers/${M.id}`,{state:{fromReports:!0,month:i}}),q()},children:"View full profile"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Total Deliveries"}),e.jsx("p",{className:"text-lg font-semibold text-gray-900",children:k.length})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Total Milk"}),e.jsxs("p",{className:"text-lg font-semibold text-gray-900",children:[k.reduce((t,l)=>t+l.quantity,0).toFixed(2)," L"]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-2",children:"Deliveries"}),k.length===0?e.jsx("p",{className:"text-gray-500",children:"No deliveries for this month."}):e.jsx("div",{className:"overflow-x-auto border rounded-lg",children:e.jsxs("table",{className:"w-full text-xs md:text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left py-2 px-2",children:"Date"}),e.jsx("th",{className:"text-right py-2 px-2",children:"Qty (L)"}),e.jsx("th",{className:"text-right py-2 px-2",children:"Price/L (₹)"}),e.jsx("th",{className:"text-right py-2 px-2",children:"Amount (₹)"}),e.jsx("th",{className:"text-left py-2 px-2",children:"Milk quality / Notes"}),e.jsx("th",{className:"text-center py-2 px-2",children:"Edit"})]})}),e.jsx("tbody",{children:k.map(t=>{const l=t.quantity>0?t.amount/t.quantity:0;return e.jsxs("tr",{className:"border-t border-gray-100",children:[e.jsx("td",{className:"py-2 px-2",children:w(new Date(t.date),"dd MMM")}),e.jsx("td",{className:"py-2 px-2 text-right",children:t.quantity.toFixed(2)}),e.jsxs("td",{className:"py-2 px-2 text-right",children:["₹",l.toFixed(2)]}),e.jsxs("td",{className:"py-2 px-2 text-right font-semibold",children:["₹",t.amount.toFixed(2)]}),e.jsx("td",{className:"py-2 px-2 text-gray-600 max-w-[160px] truncate",children:t.milkQuality?t.milkQuality==="cow"?"Cow milk":t.milkQuality==="buffalo"?"Buffalo milk":t.milkQuality==="mixed"?"Mixed milk":"Other":t.notes||"-"}),e.jsx("td",{className:"py-2 px-2 text-center",children:e.jsxs("button",{type:"button",onClick:()=>te(t.id),className:"inline-flex items-center px-2 py-1 text-[11px] rounded-md border border-gray-200 hover:bg-gray-50 text-gray-700",children:[e.jsx(he,{size:12,className:"mr-1"}),"Price"]})})]},t.id)})})]})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-2",children:"Payments"}),W.length===0?e.jsx("p",{className:"text-gray-500",children:"No payments recorded for this month."}):e.jsx("div",{className:"overflow-x-auto border rounded-lg",children:e.jsxs("table",{className:"w-full text-xs md:text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left py-2 px-2",children:"Date"}),e.jsx("th",{className:"text-right py-2 px-2",children:"Amount (₹)"}),e.jsx("th",{className:"text-left py-2 px-2",children:"Method"}),e.jsx("th",{className:"text-left py-2 px-2",children:"Note"})]})}),e.jsx("tbody",{children:W.map(t=>e.jsxs("tr",{className:"border-t border-gray-100",children:[e.jsx("td",{className:"py-2 px-2",children:t.date}),e.jsxs("td",{className:"py-2 px-2 text-right font-semibold",children:["₹",t.amount.toFixed(2)]}),e.jsx("td",{className:"py-2 px-2 capitalize",children:t.method}),e.jsx("td",{className:"py-2 px-2 text-gray-600 max-w-[200px] truncate",children:t.note||"-"})]},t.id))})]})})]}),A&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-sm w-full mx-4 p-5",children:[e.jsx("h3",{className:"text-base font-semibold mb-3",children:"Update price per litre"}),e.jsxs("form",{onSubmit:se,className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Price per litre (₹)"}),e.jsx("input",{type:"number",min:"0",step:"0.01",value:z,onChange:t=>P(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500",autoFocus:!0})]}),e.jsxs("div",{className:"flex justify-end space-x-2 pt-2",children:[e.jsx(I,{type:"button",variant:"secondary",onClick:()=>{R(null),P("")},children:"Cancel"}),e.jsx(I,{type:"submit",children:"Save"})]})]})]})})]}):e.jsx("p",{className:"text-gray-500 text-center py-8",children:y?"No customers match this search for the selected month":"No data for this month"})})]})};export{Ae as Reports};
